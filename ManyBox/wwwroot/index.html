<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>ManyBox</title>
    <base href="/" />
    <link rel="stylesheet" href="css/bootstrap/bootstrap.min.css" />
    <link rel="stylesheet" href="css/app.css" />
    <link rel="stylesheet" href="css/superadmin.css" />
    <link rel="stylesheet" href="ManyBox.styles.css" />
    <link rel="stylesheet" href="css/ChatDashboard.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="icon" href="data:,">
    <script src="js/firmaCanvas.js"></script>
    <script src="js/toggleNav.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="js/qrscanner.js"></script>
    <link href="css/jsonviewer.css" rel="stylesheet" />
</head>

<body>
    <div class="status-bar-safe-area"></div>

    <div id="app">
        <div class="loading-container">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2">Cargando ManyBox...</p>
        </div>
    </div>

    <div id="blazor-error-ui">
        <div class="alert alert-danger m-3" role="alert">
            <h5>‚ö†Ô∏è Error no controlado</h5>
            <p>Se produjo un error inesperado en la aplicaci√≥n.</p>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-danger btn-sm reload">üîÑ Recargar</button>
                <button class="btn btn-outline-secondary btn-sm dismiss">‚úñÔ∏è Cerrar</button>
            </div>
        </div>
    </div>

    <script src="_framework/blazor.webview.js" autostart="false"></script>

    <script>
        // Helper para abrir el InputFile oculto sin usar eval
        window.mbClickFileInput = function () {
            const el = document.querySelector('[data-fileinput] input[type=file]') || document.querySelector('input[data-fileinput]') || document.querySelector('[data-fileinput]');
            if (el) el.click();
        };
        // Nuevo helper: abrir por referencia segura
        window.mbClickFileInputByRef = function (element) {
            try {
                if (element && element instanceof HTMLElement) {
                    element.click();
                    return;
                }
                // Fallback
                window.mbClickFileInput();
            } catch (e) {
                console.error('mbClickFileInputByRef error:', e);
                try { window.mbClickFileInput(); } catch {}
            }
        };

        // Manejo mejorado de errores JavaScript
        window.addEventListener('error', function (e) {
            console.error('Error JavaScript:', e.error);
        });
        window.addEventListener('unhandledrejection', function (e) {
            console.error('Promise rechazada:', e.reason);
        });

        // Funciones existentes
        window.descargarArchivo = async function (nombreArchivo, contenidoStreamRef) {
            try {
                const arrayBuffer = await contenidoStreamRef.arrayBuffer();
                const blob = new Blob([arrayBuffer]);
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = nombreArchivo;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error al descargar archivo:', error);
                alert('Error al descargar el archivo. Por favor, int√©ntalo de nuevo.');
            }
        };

        window.scrollToBottom = (element) => {
            try {
                if (element) {
                    element.scrollTop = element.scrollHeight;
                }
            } catch (error) {
                console.error('Error al hacer scroll:', error);
            }
        };

        document.addEventListener('DOMContentLoaded', function () {
            const reloadButton = document.querySelector('#blazor-error-ui .reload');
            const dismissButton = document.querySelector('#blazor-error-ui .dismiss');
            if (reloadButton) reloadButton.addEventListener('click', function () { location.reload(); });
            if (dismissButton) dismissButton.addEventListener('click', function () { document.querySelector('#blazor-error-ui').style.display = 'none'; });
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="_content/Blazor-ApexCharts/apex-charts.min.js"></script>
    <script src="_content/Blazor-ApexCharts/blazor-apex-charts.js"></script>
    <script>
        window.exportarPaquetesPDF = function (datosTabla, titulo = "Lista de Paquetes") {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(16);
            doc.text(titulo, 10, 15);
            const rows = JSON.parse(datosTabla);
            let startY = 25;
            rows.forEach((fila, index) => {
                let texto = Object.entries(fila).map(([k, v]) => `${k}: ${v}`).join(", ");
                doc.text(texto, 10, startY + (index * 10));
            });
            doc.save(`${titulo}.pdf`);
        };
    </script>
    <script src="js/dashboard.js"></script>
    <script src="js/ventas.js"></script>

    <style>
        .loading-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; text-align: center; }
        #blazor-error-ui { position: fixed; top: 0; left: 0; right: 0; z-index: 9999; display: none; }
        .error-boundary .alert { margin: 1rem; }
    </style>

</body>

</html></html>