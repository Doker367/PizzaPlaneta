@page "/paquetes"

@using ManyBox.Utils

<h1>📦 Lista de Paquetes</h1>

<div class="filter-section">
    <input placeholder="Buscar por destinatario..." @bind="filtroDestinatario" class="input-filter" />
    <input type="date" @bind="filtroFecha" class="input-filter" />
    <select @bind="filtroEstado" class="input-filter">
        <option value="">Todos los estados</option>
        @foreach (var estado in EstadosPosibles)
        {
            <option value="@estado">@estado</option>
        }
    </select>
    <button class="btn-filtrar" @onclick="FiltrarPaquetes">🔍 Filtrar</button>
</div>

@if (paquetesFiltrados.Count == 0)
{
    <p class="no-data">No hay paquetes registrados actualmente.</p>
}
else
{
    <table class="paquetes-table">
        <thead>
            <tr>
                <th>#</th>
                <th>Folio</th>
                <th>Guía</th> <!-- Nueva columna Guía -->
                <th>Destino</th>
                <th>Estado</th>
                <th>Tipo</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            @for (int i = 0; i < paquetesFiltrados.Count; i++)
            {
                var paquete = paquetesFiltrados[i];
                <tr>
                    <td>@(i + 1)</td>
                    <td>@paquete.CodigoSeguimiento</td>
                    <td>@paquete.NumeroGuia</td> <!-- Mostrar la guía aquí -->
                    <td>@paquete.CiudadDestino</td>
                    <td><span class="estado @GetStatusClass(paquete.EstadoActual)">@paquete.EstadoActual</span></td>
                    <td>@paquete.TipoEnvio</td>
                    <td>
                        <button @onclick="() => VerDetalles(paquete.Id)">📄</button>
                        <button @onclick="() => DescargarComprobante(paquete.Id)">⬇️</button>
                        @if (SessionState.Rol == "SuperAdmin")
                        {
                            <button class="btn-danger" @onclick="() => Eliminar(paquete.Id)">🗑️</button>
                        }
                        @if (!string.IsNullOrWhiteSpace(paquete.TipoEnvio) && paquete.TipoEnvio.Contains("DHL", StringComparison.OrdinalIgnoreCase))
                        {
                            <button title="Rellenar Cotización DHL" @onclick="() => PrefillDhlRates(paquete)">💲 DHL</button>
                            <button title="Rellenar Crear Envío DHL" @onclick="() => PrefillDhlCreate(paquete)">📦 DHL</button>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@if (mostrarDetalles && paqueteSeleccionado != null)
{
    <div class="modal-overlay">
        <div class="modal-content">
            <h2>📦 Detalles del Paquete</h2>
            <ul>
                <li><strong>Folio:</strong> @paqueteSeleccionado.CodigoSeguimiento</li>
                <li><strong>Fecha Registro:</strong> @paqueteSeleccionado.FechaRegistro.ToShortDateString()</li>
                <li><strong>Sucursal Origen:</strong> @paqueteSeleccionado.SucursalOrigen</li>
                <li><strong>Remitente:</strong> @paqueteSeleccionado.RemitenteNombre (@paqueteSeleccionado.RemitenteTelefono)</li>
                <li><strong>Destinatario:</strong> @paqueteSeleccionado.DestinatarioNombre (@paqueteSeleccionado.DestinatarioTelefono)</li>
                <li><strong>Dirección Destino:</strong> @paqueteSeleccionado.DireccionDestino</li>
                <li><strong>Ciudad/Estado:</strong> @paqueteSeleccionado.CiudadDestino</li>
                <li><strong>Tipo de Envío:</strong> @paqueteSeleccionado.TipoEnvio</li>
                <li><strong>Estado Actual:</strong> <span class="estado @GetStatusClass(paqueteSeleccionado.EstadoActual)">@paqueteSeleccionado.EstadoActual</span></li>
                <li><strong>Última Actualización:</strong> @paqueteSeleccionado.FechaUltimaActualizacion?.ToShortDateString()</li>
                <li><strong>Registrado por:</strong> @paqueteSeleccionado.EmpleadoRegistro</li>
                <li><strong>Repartidor asignado:</strong> @paqueteSeleccionado.RepartidorAsignado</li>
                <li><strong>Peso:</strong> @paqueteSeleccionado.PesoKg kg</li>
                <!-- Eliminado campo de Guía aquí -->
                <li><strong>Costo:</strong> $@paqueteSeleccionado.CostoEnvio</li>
            </ul>
            <button @onclick="() => mostrarDetalles = false">Cerrar</button>
        </div>
    </div>
}

@code {
    private string GetStatusClass(string estado)
    {
        return estado?.ToLower().Replace(" ", "-") ?? string.Empty;
    }
}


