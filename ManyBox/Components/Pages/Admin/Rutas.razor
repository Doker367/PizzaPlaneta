@page "/rutas"

@using ManyBox.Utils

<div class="page-container dark">
    <div class="header-section">
        <h1 class="page-title">Gestión de Rutas y Reparto</h1>
    </div>

    <div class="form-card dark">
        <h2>Asignar Paquete</h2>
        <div class="form-section">
            <label for="ventaSelector">Selecciona una Venta</label>
            <select id="ventaSelector" class="form-control dark" @bind="VentaSeleccionadaId">
                <option value="">-- Selecciona una venta --</option>
                @foreach (var venta in VentasDisponibles)
                {
                    <option value="@venta.Id">@venta.Folio (@venta.DestinatarioNombre)</option>
                }
            </select>
        </div>
        <div class="form-section">
            <label for="guiaRastreo">Guía de Rastreo</label>
            <input id="guiaRastreo" class="form-control dark" @bind-value="GuiaRastreo" @bind-value:event="oninput" placeholder="Ej. ENVIO-1001" />
        </div>
        <div class="form-section">
            <label for="fechaEntrega">Fecha de Entrega</label>
            <input id="fechaEntrega" type="date" class="form-control dark" @bind="FechaEntregaAsignar" />
        </div>
        <div class="form-section">
            <label for="empleado">Empleado (Conductor)</label>
            <select id="empleado" class="form-control dark" @bind="EmpleadoSeleccionadoId">
                <option value="">-- Selecciona un empleado --</option>
                @foreach (var empleado in Empleados)
                {
                    <option value="@empleado.Id">@empleado.NombreCompleto</option>
                }
            </select>
        </div>
        <div class="button-group">
            <button class="btn-asignar" @onclick="AsignarPaquete">Asignar</button>
            <button class="btn-limpiar" @onclick="LimpiarFormulario">Limpiar</button>
        </div>
    </div>

    <div class="tabla-card dark">
        <h2>Paquetes Asignados</h2>
        <table class="data-table dark">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Guía de Rastreo</th>
                    <th>Fecha Entrega</th>
                    <th>Empleado Asignado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @if (PaquetesAsignados.Count == 0)
                {
                    <tr><td colspan="5" class="sin-datos">No hay paquetes asignados.</td></tr>
                }
                else
                {
                    var idx = 1;
                    @foreach (var asignado in PaquetesAsignados)
                    {
                        <tr>
                            <td>@idx</td>
                            <td>
                                <div style="display:flex;align-items:center;gap:.5rem;">
                                    <span>@asignado.CodigoSeguimiento</span>
                                    @if (!string.IsNullOrWhiteSpace(asignado.Estado))
                                    {
                                        <span class="estado-badge @GetEstadoCss(asignado.Estado)">@asignado.Estado</span>
                                    }
                                </div>
                            </td>
                            <td>@(asignado.FechaEntrega?.ToString("yyyy-MM-dd") ?? "-")</td>
                            <td>@asignado.EmpleadoAsignado</td>
                            <td>
                                @if (UsuarioEsAdmin && !asignado.Entregado)
                                {
                                    <button class="btn-filtrar" @onclick="() => AbrirModalFecha(asignado)">Editar fecha</button>
                                }
                                else if (asignado.Entregado)
                                {
                                    <span class="estado-badge entregado">Cerrado</span>
                                }
                                else
                                {
                                    <span>-</span>
                                }
                            </td>
                        </tr>
                        idx++;
                    }
                }
            </tbody>
        </table>
    </div>

    @if (ModalFechaVisible && PaqueteEditando != null)
    {
        <div class="modal-overlay modal-fecha-overlay">
            <div class="modal-fecha-card">
                <h2>Editar Fecha de Entrega</h2>
                <div class="modal-fecha-body">
                    <label for="fechaEntregaEdit" class="modal-fecha-label">Nueva fecha de entrega:</label>
                    <input id="fechaEntregaEdit" type="date" class="modal-fecha-input" @bind="FechaEntregaEdit" />
                </div>
                <div class="modal-fecha-actions">
                    <button class="btn-asignar" @onclick="GuardarFechaEntrega">Guardar</button>
                    <button class="btn-limpiar" @onclick="CerrarModalFecha">Cancelar</button>
                </div>
            </div>
        </div>
    }
</div>

<style>
.modal-fecha-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(34, 42, 58, 0.64);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}
.modal-fecha-card {
    background: #23243a;
    color: #fff;
    border-radius: 18px;
    padding: 2.2rem 2.5rem 1.5rem 2.5rem;
    box-shadow: 0 8px 40px #212b361a;
    min-width: 320px;
    max-width: 94vw;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.2rem;
}
.modal-fecha-card h2 {
    color: #7b5cff;
    font-size: 1.3rem;
    font-weight: 700;
    margin-bottom: 0.7rem;
    text-align: center;
}
.modal-fecha-body {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 0.7rem;
}
.modal-fecha-label {
    font-weight: 600;
    color: #b0c4df;
    font-size: 1.08rem;
}
.modal-fecha-input {
    background: #181a20;
    color: #fff;
    border: 1.5px solid #35365a;
    border-radius: 8px;
    padding: 0.6rem 1.2rem;
    font-size: 1.08rem;
    width: 100%;
}
.modal-fecha-actions {
    margin-top: 1.2rem;
    display: flex;
    gap: 1.2rem;
    width: 100%;
    justify-content: center;
}
.btn-asignar {
    background: #3772ff;
    color: #fff;
    border: none;
    border-radius: 10px;
    font-size: 1rem;
    padding: 0.5rem 1.2rem;
    font-weight: 600;
    transition: background 0.18s, color 0.18s, box-shadow 0.18s;
}
.btn-asignar:hover {
    background: #7b5cff;
    color: #fff;
    box-shadow: 0 2px 12px #23243a55;
}
.btn-limpiar {
    background: #e67373;
    color: #fff;
    border: none;
    border-radius: 10px;
    font-size: 1rem;
    padding: 0.5rem 1.2rem;
    font-weight: 600;
    transition: background 0.18s, color 0.18s, box-shadow 0.18s;
}
.btn-limpiar:hover {
    background: #b53434;
    color: #fff;
    box-shadow: 0 2px 12px #23243a55;
}
.estado-badge {
    padding: .18rem .5rem;
    border-radius: .6rem;
    font-size: .78rem;
    font-weight: 700;
    color: #fff;
}
.estado-badge.entregado { background: #22c55e; }
.estado-badge.incidencia-cerrada { background: #ef4444; }
.estado-badge.incidencia { background: #f59e0b; }
.estado-badge.en-camino { background: #3b82f6; }
.estado-badge.ultimo-tramo { background: #8b5cf6; }
.estado-badge.asignado { background: #64748b; }
.estado-badge.otro { background: #334155; }
</style>

