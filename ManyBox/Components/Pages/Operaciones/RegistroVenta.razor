@page "/registro-venta"
@page "/registro-venta/{Id:int}"
@inject HttpClient Http
@using ManyBox.Utils

@if ((SessionState.Rol ?? "").ToLower() == "chofer")
{
    <div class="alert alert-danger">No tienes permiso para acceder a esta página.</div>
}
else
{
    <EditForm Model="@venta" OnValidSubmit="RegistrarVenta">
        <DataAnnotationsValidator />
        <ValidationSummary />
        <div class="registro-venta-container dark">
            <!-- Tarjeta de Cliente -->
            <div class="cliente-card dark">
                <h2 class="cliente-title dark">Sección de Cliente</h2>
                <form class="cliente-buscador-form" @onsubmit="OnBuscarClienteSubmit">
                    <input class="cliente-buscador-input" type="text" @bind="busquedaCliente" placeholder="Buscar por nombre, email o teléfono..." />
                    <button class="cliente-buscador-btn" type="submit">Buscar</button>
                </form>
                @if (clientesEncontrados?.Count > 0)
                {
                    <div class="cliente-buscador-list">
                        @foreach (var cliente in clientesEncontrados)
                        {
                            <div class="cliente-buscador-item @(cliente.Id == venta.Cliente_Id ? "selected" : "")" @onclick="() => SeleccionarCliente(cliente)">
                                <span>@cliente.Nombre @cliente.Apellido (@cliente.Correo, @cliente.Telefono)</span>
                            </div>
                        }
                    </div>
                }
                @if (clienteSeleccionado is not null)
                {
                    <div class="cliente-buscador-seleccionado">
                        Cliente seleccionado: <b>@clienteSeleccionado?.Nombre @clienteSeleccionado?.Apellido</b>
                    </div>
                }
                @if (!clienteSeleccionado?.Id.Equals(venta.Cliente_Id) ?? true)
                {
                    <div class="validation-message">Selecciona un cliente antes de registrar la venta.</div>
                }
            </div>

            <!-- Tarjeta de Registro de Venta -->
            <div class="registro-venta-card dark">
                <h1 class="registro-venta-title dark">Registro de Venta</h1>
                <div class="registro-venta-section dark">
                    <h3>Remitente</h3>
                    <div class="registro-venta-grid">
                        <InputText class="form-control dark-input" @bind-value="venta.Remitente_Nombre" placeholder="Nombre" required />
                        <InputText class="form-control dark-input" @bind-value="venta.Remitente_Telefono" placeholder="Teléfono" required />
                        <InputText class="form-control dark-input" @bind-value="venta.Remitente_Direccion" placeholder="Dirección" required />
                        <InputText class="form-control dark-input" @bind-value="venta.Remitente_Ciudad" placeholder="Ciudad" required />
                        <InputText class="form-control dark-input" @bind-value="venta.Remitente_Estado" placeholder="Estado" required />
                        <InputText class="form-control dark-input" @bind-value="venta.Remitente_Pais" placeholder="País" required />
                        <InputText class="form-control dark-input" @bind-value="venta.Remitente_Cp" placeholder="Código Postal" required />
                    </div>
                </div>

                <div class="registro-venta-section dark">
                    <h3>Destinatario</h3>
                    <div class="registro-venta-grid">
                        <InputText class="form-control dark-input" @bind-value="venta.Destinatario_Nombre" placeholder="Nombre" required />
                        <InputText class="form-control dark-input" @bind-value="venta.Destinatario_Telefono" placeholder="Teléfono" required />
                        <InputText class="form-control dark-input" @bind-value="venta.Destinatario_Direccion" placeholder="Dirección" required />
                        <InputText class="form-control dark-input" @bind-value="venta.Destinatario_Ciudad" placeholder="Ciudad" required />
                        <InputText class="form-control dark-input" @bind-value="venta.Destinatario_Estado" placeholder="Estado" required />
                        <InputText class="form-control dark-input" @bind-value="venta.Destinatario_Pais" placeholder="País" required />
                        <InputText class="form-control dark-input" @bind-value="venta.Destinatario_Cp" placeholder="Código Postal" required />
                    </div>
                </div>

                <div class="registro-venta-section dark">
                    <div class="venta-header">
                        <h3>Datos de la Venta</h3>
                        <span class="folio-text" title="Folio">@venta.Folio</span>
                    </div>
                    <div class="registro-venta-grid">
                        <!-- Folio eliminado del formulario; ahora solo se muestra a la derecha del ttulo -->
                        <InputText class="form-control dark-input" @bind-value="venta.Compania_Envio" placeholder="Compañía de Envío" required />
                        <InputText class="form-control dark-input" @bind-value="venta.Tipo_Pago" placeholder="Tipo de Pago" required />
                        <InputNumber class="form-control dark-input" @bind-value="venta.Total_Cobrado" placeholder="Total Cobrado" required />
                        <InputNumber class="form-control dark-input" @bind-value="venta.Total_Piezas" placeholder="Total Piezas" required />
                        <InputText class="form-control dark-input" @bind-value="venta.Tiempo_Estimado" placeholder="Tiempo Estimado" required />
                        <InputNumber class="form-control dark-input" @bind-value="venta.Valor_Declarado" placeholder="Valor Declarado" required />
                        <InputText class="form-control dark-input" @bind-value="venta.Medidas" placeholder="Medidas" required />
                        <InputNumber class="form-control dark-input" @bind-value="venta.Peso_Volumetrico" placeholder="Peso Volumétrico" required />
                        <InputNumber class="form-control dark-input" @bind-value="venta.Peso_Fisico" placeholder="Peso Físico" required />
                        <div style="display:flex;align-items:center;gap:.5rem;">
                            <InputCheckbox class="form-check-input" @bind-value="seguroAux" /> <span>¿Seguro?</span>
                        </div>
                        <InputText class="form-control dark-input" @bind-value="venta.Tipo_Riesgo" placeholder="Tipo de Riesgo" required />
                        <InputNumber class="form-control dark-input" @bind-value="venta.Costo_Envio" placeholder="Costo Envío" required />
                    </div>
                </div>
            </div>

            <!-- Tarjeta de Detalle de Contenido centrada -->
            <div class="detalle-contenido-card dark">
                <h3 class="detalle-contenido-title">Detalle de Contenido</h3>
                <div class="detalle-contenido-list">
                    @foreach (var item in venta.DetalleContenido)
                    {
                        <div class="detalle-contenido-row">
                            <InputText class="form-control dark-input" @bind-value="item.Descripcion" placeholder="Descripción" required />
                            <InputNumber class="form-control dark-input" @bind-value="item.Cantidad" placeholder="Cantidad" required />
                            <InputText class="form-control dark-input" @bind-value="item.Unidad" placeholder="Unidad" required />
                        </div>
                    }
                    <button type="button" class="btn-add dark-btn" @onclick="AgregarDetalleContenido">Agregar Detalle</button>
                </div>
            </div>

            <div class="registro-venta-actions">
                <button type="button" class="btn-primary dark-btn" @onclick="GuardarIncompleta">Guardar como incompleta</button>
                <button type="submit" class="btn-primary dark-btn" style="margin-left:8px;">Registrar Venta</button>
            </div>
            @if (!string.IsNullOrEmpty(mensaje))
            {
                <div class="registro-venta-mensaje dark">@mensaje</div>
            }
        </div>
    </EditForm>
}
