@page "/dhl/landed-cost"
@using ManyBox.Models.Dhl
@using System.Net.Http
@using System.Net.Http.Json
@using ManyBox.Components.Shared
@using System.Globalization
@inject HttpClient Http

@if (OperatingSystem.IsWindows())
{
    <div class="main-content">
        <div class="page-header">
            <h1 class="page-title">DHL - Costo de Entrega</h1>
            <p class="page-subtitle">Calcula el costo de entrega con DHL.</p>
        </div>

        <div class="card">
            <div class="card-body">
                <EditForm Model="@landedCostRequest" OnValidSubmit="HandleValidSubmit">
                    <DataAnnotationsValidator />

                    <div class="row">
                        <div class="col-md-6">
                            <h5>Remitente</h5>
                            <div class="form-group">
                                <label>Código Postal</label>
                                <InputText class="form-control" @bind-Value="landedCostRequest.CustomerDetails.ShipperDetails.PostalCode" />
                            </div>
                            <div class="form-group">
                                <label>Ciudad</label>
                                <InputText class="form-control" @bind-Value="landedCostRequest.CustomerDetails.ShipperDetails.CityName" />
                            </div>
                            <div class="form-group">
                                <label>Código de País</label>
                                <InputText class="form-control" @bind-Value="landedCostRequest.CustomerDetails.ShipperDetails.CountryCode" />
                            </div>

                            <h5>Destinatario</h5>
                            <div class="form-group">
                                <label>Código Postal</label>
                                <InputText class="form-control" @bind-Value="landedCostRequest.CustomerDetails.ReceiverDetails.PostalCode" />
                            </div>
                            <div class="form-group">
                                <label>Ciudad</label>
                                <InputText class="form-control" @bind-Value="landedCostRequest.CustomerDetails.ReceiverDetails.CityName" />
                            </div>
                            <div class="form-group">
                                <label>Código de País</label>
                                <InputText class="form-control" @bind-Value="landedCostRequest.CustomerDetails.ReceiverDetails.CountryCode" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h5>Detalles del Envío</h5>
                            <div class="form-group">
                                <label>Código de Producto</label>
                                <InputText class="form-control" @bind-Value="landedCostRequest.ProductCode" />
                            </div>
                            <div class="form-group">
                                <label>Código de Producto Local</label>
                                <InputText class="form-control" @bind-Value="landedCostRequest.LocalProductCode" />
                            </div>
                            <div class="form-group">
                                <label>Unidad de Medida</label>
                                <InputText class="form-control" @bind-Value="landedCostRequest.UnitOfMeasurement" />
                            </div>
                            <div class="form-group">
                                <label>Código de Moneda</label>
                                <InputText class="form-control" @bind-Value="landedCostRequest.CurrencyCode" />
                            </div>
                            <div class="form-group">
                                <label>Propósito del Envío</label>
                                <InputText class="form-control" @bind-Value="landedCostRequest.ShipmentPurpose" />
                            </div>
                            <div class="form-group">
                                <label>Modo de Transporte</label>
                                <InputText class="form-control" @bind-Value="landedCostRequest.TransportationMode" />
                            </div>
                            <div class="form-group">
                                <label>Transportista Seleccionado por el Comerciante</label>
                                <InputText class="form-control" @bind-Value="landedCostRequest.MerchantSelectedCarrierName" />
                            </div>
                            <div class="form-check">
                                <InputCheckbox class="form-check-input" @bind-Value="landedCostRequest.IsCustomsDeclarable" />
                                <label class="form-check-label">Declarable en Aduana</label>
                            </div>
                            <div class="form-check">
                                <InputCheckbox class="form-check-input" @bind-Value="isDTPRequested" />
                                <label class="form-check-label">DTP Solicitado</label>
                            </div>
                            <div class="form-check">
                                <InputCheckbox class="form-check-input" @bind-Value="isInsuranceRequested" />
                                <label class="form-check-label">Seguro Solicitado</label>
                            </div>
                            <div class="form-check">
                                <InputCheckbox class="form-check-input" @bind-Value="landedCostRequest.GetCostBreakdown" />
                                <label class="form-check-label">Obtener Desglose de Costos</label>
                            </div>
                            <div class="form-check">
                                <InputCheckbox class="form-check-input" @bind-Value="getTariffFormula" />
                                <label class="form-check-label">Obtener Fórmula de Tarifa</label>
                            </div>
                            <div class="form-check">
                                <InputCheckbox class="form-check-input" @bind-Value="getQuotationID" />
                                <label class="form-check-label">Obtener ID de Cotización</label>
                            </div>
                        </div>
                    </div>

                    <h5>Cargos</h5>
                    @for (int i = 0; i < landedCostRequest.Charges.Count; i++)
                    {
                        var charge = landedCostRequest.Charges[i];
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Código de Tipo</label>
                                    <InputText class="form-control" @bind-Value="charge.TypeCode" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Monto</label>
                                    <InputNumber TValue="decimal" class="form-control" @bind-Value="charge.Amount" @culture="usCulture" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Código de Moneda</label>
                                    <InputText class="form-control" @bind-Value="charge.CurrencyCode" />
                                </div>
                            </div>
                        </div>
                    }
                    <button type="button" class="btn btn-secondary" @onclick="AddCharge">Agregar Cargo</button>

                    <h5>Paquetes</h5>
                    @for (int i = 0; i < landedCostRequest.Packages.Count; i++)
                    {
                        var pkg = landedCostRequest.Packages[i];
                        <div class="row">
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>Peso (kg)</label>
                                    <InputNumber TValue="decimal" class="form-control" @bind-Value="pkg.Weight" @culture="usCulture" />
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Largo (cm)</label>
                                    <InputNumber TValue="decimal" class="form-control" @bind-Value="pkg.Dimensions.Length" @culture="usCulture" />
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Ancho (cm)</label>
                                    <InputNumber TValue="decimal" class="form-control" @bind-Value="pkg.Dimensions.Width" @culture="usCulture" />
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label>Alto (cm)</label>
                                    <InputNumber TValue="decimal" class="form-control" @bind-Value="pkg.Dimensions.Height" @culture="usCulture" />
                                </div>
                            </div>
                        </div>
                    }
                    <button type="button" class="btn btn-secondary" @onclick="AddPackage">Agregar Paquete</button>

                    <h5>Ítems</h5>
                    @for (int i = 0; i < landedCostRequest.Items.Count; i++)
                    {
                        var item = landedCostRequest.Items[i];
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Número</label>
                                    <InputNumber TValue="int" class="form-control" @bind-Value="item.Number" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Nombre</label>
                                    <InputText class="form-control" @bind-Value="item.Name" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Descripción</label>
                                    <InputText class="form-control" @bind-Value="item.Description" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>País de Fabricación</label>
                                    <InputText class="form-control" @bind-Value="item.ManufacturerCountry" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Número de Parte</label>
                                    <InputText class="form-control" @bind-Value="item.PartNumber" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Cantidad</label>
                                    <InputNumber TValue="int" class="form-control" @bind-Value="item.Quantity" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Tipo de Cantidad</label>
                                    <InputText class="form-control" @bind-Value="item.QuantityType" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Precio Unitario</label>
                                    <InputNumber TValue="decimal" class="form-control" @bind-Value="item.UnitPrice" @culture="usCulture" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Código de Moneda del Precio Unitario</label>
                                    <InputText class="form-control" @bind-Value="item.UnitPriceCurrencyCode" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Código de Mercancía</label>
                                    <InputText class="form-control" @bind-Value="item.CommodityCode" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Peso</label>
                                    <InputNumber TValue="decimal?" class="form-control" @bind-Value="item.Weight" @culture="usCulture" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Unidad de Medida del Peso</label>
                                    <InputText class="form-control" @bind-Value="item.WeightUnitOfMeasurement" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Categoría</label>
                                    <InputText class="form-control" @bind-Value="item.Category" />
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label>Marca</label>
                                    <InputText class="form-control" @bind-Value="item.Brand" />
                                </div>
                            </div>
                        </div>
                    }
                    <button type="button" class="btn btn-secondary" @onclick="AddItem">Agregar Ítem</button>

                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary">Calcular Costo</button>
                    </div>
                </EditForm>
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(apiResponse))
        {
            <ApiResponseViewer Title="Resultado Landed Cost" Json="@apiResponse" />
        }
    </div>
}

@code {
    private CultureInfo usCulture = new CultureInfo("en-US");
    private DhlLandedCostRequest landedCostRequest = new DhlLandedCostRequest
    {
        CustomerDetails = new LandedCostCustomerDetails
        {
            ShipperDetails = new DhlAddressRatesRequest(),
            ReceiverDetails = new DhlAddressRatesRequest()
        },
        Charges = new List<Charge>(),
        Packages = new List<DhlPackageRR>(),
        Items = new List<Item>()
    };

    private bool isDTPRequested = false;
    private bool isInsuranceRequested = false;
    private bool getTariffFormula = false;
    private bool getQuotationID = false;
    private string apiResponse = string.Empty;

    protected override void OnInitialized()
    {
        landedCostRequest.Charges.Add(new Charge());
        landedCostRequest.Packages.Add(new DhlPackageRR {
            Weight = 0,
            Dimensions = new DhlDimensionsDecimal {
                Length = 0,
                Width = 0,
                Height = 0
            }
        });
        landedCostRequest.Items.Add(new Item());
    }

    private void AddCharge() => landedCostRequest.Charges.Add(new Charge());
    private void AddPackage() => landedCostRequest.Packages.Add(new DhlPackageRR { Weight = 0, Dimensions = new DhlDimensionsDecimal { Length = 0, Width = 0, Height = 0 } });
    private void AddItem() => landedCostRequest.Items.Add(new Item());

    private async Task HandleValidSubmit()
    {
        landedCostRequest.IsDTPRequested = isDTPRequested;
        landedCostRequest.IsInsuranceRequested = isInsuranceRequested;
        landedCostRequest.GetTariffFormula = getTariffFormula;
        landedCostRequest.GetQuotationID = getQuotationID;

        try
        {
            var response = await Http.PostAsJsonAsync("http://100.64.197.11:5000/api/dhl/landed-cost", landedCostRequest);
            apiResponse = await response.Content.ReadAsStringAsync();
        }
        catch (Exception ex)
        {
            apiResponse = $"Error: {ex.Message}";
        }
    }
}
