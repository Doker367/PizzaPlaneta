@page "/dhl/create-pickup"
@using ManyBox.Models.Dhl
@using System.Net.Http
@using System.Net.Http.Json
@using ManyBox.Components.Shared
@inject HttpClient Http

@if (OperatingSystem.IsWindows())
{
    <div class="main-content">
        <div class="page-header">
            <h1 class="page-title">DHL - Solicitar Recogida</h1>
            <p class="page-subtitle">Solicita una recogida de DHL.</p>
        </div>

        <div class="card">
            <div class="card-body">
                <EditForm Model="@pickupRequest" OnValidSubmit="HandleValidSubmit">
                    <DataAnnotationsValidator />

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Fecha de Recogida</label>
                                <InputText class="form-control" @bind-Value="pickupRequest.PickupDate"
                                    placeholder="YYYY-MM-DD" />
                            </div>
                            <div class="form-group">
                                <label>Hora de Cierre</label>
                                <InputText class="form-control" @bind-Value="pickupRequest.CloseTime" placeholder="HH:MM" />
                            </div>
                            <div class="form-group">
                                <label>Ubicación</label>
                                <InputText class="form-control" @bind-Value="pickupRequest.Location" />
                            </div>

                            <h5>Detalles del Remitente</h5>
                            <div class="form-group">
                                <label>Nombre Completo</label>
                                <InputText class="form-control"
                                    @bind-Value="pickupRequest.CustomerDetails.ShipperDetails.ContactInformation.FullName" />
                            </div>
                            <div class="form-group">
                                <label>Teléfono</label>
                                <InputText class="form-control"
                                    @bind-Value="pickupRequest.CustomerDetails.ShipperDetails.ContactInformation.Phone" />
                            </div>
                            <div class="form-group">
                                <label>Dirección</label>
                                <InputText class="form-control"
                                    @bind-Value="pickupRequest.CustomerDetails.ShipperDetails.PostalAddress.AddressLine1" />
                            </div>
                            <div class="form-group">
                                <label>Ciudad</label>
                                <InputText class="form-control"
                                    @bind-Value="pickupRequest.CustomerDetails.ShipperDetails.PostalAddress.CityName" />
                            </div>
                            <div class="form-group">
                                <label>Código Postal</label>
                                <InputText class="form-control"
                                    @bind-Value="pickupRequest.CustomerDetails.ShipperDetails.PostalAddress.PostalCode" />
                            </div>
                            <div class="form-group">
                                <label>Código de País</label>
                                <InputText class="form-control"
                                    @bind-Value="pickupRequest.CustomerDetails.ShipperDetails.PostalAddress.CountryCode" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h5>Detalles del Envío</h5>
                            <div class="form-group">
                                <label>Código de Producto</label>
                                <InputText class="form-control" @bind-Value="shipmentDetail.ProductCode" />
                            </div>
                            <div class="form-check">
                                <InputCheckbox class="form-check-input" @bind-Value="shipmentDetail.IsCustomsDeclarable" />
                                <label class="form-check-label">Declarable en Aduana</label>
                            </div>
                            <div class="form-group">
                                <label>Unidad de Medida</label>
                                <InputText class="form-control" @bind-Value="shipmentDetail.UnitOfMeasurement" />
                            </div>

                            <h6>Paquete</h6>
                            <div class="form-group">
                                <label>Peso (kg)</label>
                                <InputNumber TValue="decimal" class="form-control" @bind-Value="package.Weight" />
                            </div>
                            <div class="form-group">
                                <label>Largo (cm)</label>
                                <InputNumber TValue="decimal" class="form-control" @bind-Value="package.Dimensions.Length" />
                            </div>
                            <div class="form-group">
                                <label>Ancho (cm)</label>
                                <InputNumber TValue="decimal" class="form-control" @bind-Value="package.Dimensions.Width" />
                            </div>
                            <div class="form-group">
                                <label>Alto (cm)</label>
                                <InputNumber TValue="decimal" class="form-control" @bind-Value="package.Dimensions.Height" />
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">Solicitar Recogida</button>
                </EditForm>
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(apiResponse))
        {
            <ApiResponseViewer Title="Resultado Create Pickup" Json="@apiResponse" />
        }
    </div>

    @code {
        private PickupRequest pickupRequest = new PickupRequest
        {
            CustomerDetails = new CustomerDetails
            {
                ShipperDetails = new PartyDetails
                {
                    PostalAddress = new Address(),
                    ContactInformation = new Contact()
                }
            },
            ShipmentDetails = new List<ShipmentDetail>()
        };

        private ShipmentDetail shipmentDetail = new ShipmentDetail
        {
            Packages = new List<Package>()
        };

        private Package package = new Package
        {
            Weight = 0,
            Dimensions = new DhlDimensionsDecimal { Length = 0, Width = 0, Height = 0 }
        };

        private string apiResponse = string.Empty;

        protected override void OnInitialized()
        {
            shipmentDetail.Packages.Add(package);
            pickupRequest.ShipmentDetails.Add(shipmentDetail);
        }

        private async Task HandleValidSubmit()
        {
            try
            {
                var response = await Http.PostAsJsonAsync("http://100.64.197.11:5000/api/dhl/pickup", pickupRequest);
                apiResponse = await response.Content.ReadAsStringAsync();
            }
            catch (Exception ex)
            {
                apiResponse = $"Error: {ex.Message}";
            }
        }
    }
}
