@page "/chofer-dashboard"
@using ManyBox.Utils

@code {
    // Variable para el nombre del usuario
    private string usuario = "";

    protected override void OnInitialized()
    {
        // Obtener el nombre del usuario igual que en HomeAdmin
        usuario = SessionState.Usuario;
    }
}

<div class="chofer-dashboard mb-container" aria-label="Panel principal de chofer">
    <section class="mb-card mb-mb-lg" aria-labelledby="dashboard-header">
        <div class="mb-card-header mb-flex mb-items-center mb-gap-lg">
            <img src="/img/driver-avatar.svg" alt="Avatar Chofer" class="chofer-avatar" width="58" height="58" />
            <div>
                <h1 id="dashboard-header" class="mb-text-2xl mb-font-bold">Bienvenido, @(usuario ?? "Chofer")</h1>
                <p class="mb-text-lg mb-text-muted">Tu panel de trabajo diario</p>
            </div>
        </div>
        <div class="mb-card-body mb-grid mb-grid-cols-3 mb-gap-lg" aria-label="Resumen rápido">
            <div class="chofer-summary-card" aria-label="Paquetes pendientes">
                <span class="chofer-summary-icon"><i class="fa fa-box-open" aria-hidden="true"></i></span>
                <span class="mb-font-bold mb-text-xl">@paquetesPendientes</span>
                <span class="mb-text-sm mb-text-muted">Pendientes</span>
            </div>
            <div class="chofer-summary-card" aria-label="Confirmados">
                <span class="chofer-summary-icon"><i class="fa fa-check-double" aria-hidden="true"></i></span>
                <span class="mb-font-bold mb-text-xl">@paquetesConfirmados</span>
                <span class="mb-text-sm mb-text-muted">Confirmados</span>
            </div>
            <div class="chofer-summary-card" aria-label="Incidencias">
                <span class="chofer-summary-icon"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i></span>
                <span class="mb-font-bold mb-text-xl">@paquetesIncidencia</span>
                <span class="mb-text-sm mb-text-muted">Incidencias</span>
            </div>
        </div>
    </section>

    <section class="mb-grid mb-gap-lg mb-mb-lg mb-grid-cols-2" aria-label="Secciones principales">
        <div class="mb-card" aria-labelledby="guias-header">
            <div class="mb-card-header">
                <h2 id="guias-header" class="mb-text-xl mb-font-bold">📦 Guías Asignadas</h2>
            </div>
            <div class="mb-card-body">
                @if (guiasAsignadas.Any())
                {
                    <ul class="guias-list" aria-label="Lista de guías">
                        @foreach (var guia in guiasAsignadas)
                        {
                            <li class="guia-item" aria-label="Guía @guia.GuiaRastreo">
                                <div class="mb-flex mb-items-center mb-gap-md guia-header"
                                     @onclick="() => ToggleExpand(guia)"
                                     tabindex="0"
                                     role="button"
                                     aria-expanded="@guia.Expandido"
                                     aria-controls="guia-@guia.GuiaRastreo">
                                    <span class="guia-codigo">@guia.GuiaRastreo</span>
                                    <span class="guia-nombre">@guia.Destinatario</span>
                                    <button class="expand-btn mb-btn mb-btn-ghost" aria-label="Ver detalles">
                                        <span>@(guia.Expandido ? "▲" : "▼")</span>
                                    </button>
                                </div>
                                @if (guia.Expandido)
                                {
                                    <div class="timeline-card" id="guia-@guia.GuiaRastreo" aria-live="polite">
                                        <ul class="timeline">
                                            @for (int i = 0; i < guia.Estados.Count; i++)
                                            {
                                                var estado = guia.Estados[i];
                                                <li class="timeline-step @(i < guia.EstadoActual ? "completed" : (i == guia.EstadoActual ? "actual" : ""))">
                                                    <div class="timeline-dot"></div>
                                                    <div class="timeline-content">
                                                        <div class="timeline-title">@estado.Titulo</div>
                                                        <div class="timeline-desc">@estado.Descripcion</div>
                                                        <div class="timeline-date">@(estado.FechaHora.Year > 2000 ? estado.FechaHora.ToString("dd MMM, HH:mm") : "")</div>
                                                    </div>
                                                </li>
                                            }
                                        </ul>
                                        @if (guia.EstadoActual == 0)
                                        {
                                            <button class="btn-entregar mb-btn mb-btn-primary mb-mt-sm" @onclick="() => CambiarEstado(guia, 1)">Recoger paquete</button>
                                        }
                                        else if (guia.EstadoActual == 1)
                                        {
                                            <button class="btn-entregar mb-btn mb-btn-primary mb-mt-sm" @onclick="() => CambiarEstado(guia, 2)">Iniciar entrega</button>
                                        }
                                        else if (guia.EstadoActual == 2)
                                        {
                                            <button class="btn-entregar mb-btn mb-btn-success mb-mt-sm" @onclick="() => MostrarEntrega(guia)">Entregar</button>
                                        }
                                    </div>
                                }
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <div class="mb-alert mb-alert-info mb-mt-md">No tienes guías asignadas actualmente.</div>
                }
            </div>
        </div>

        <div class="mb-card" aria-labelledby="qr-header">
            <div class="mb-card-header">
                <h2 id="qr-header" class="mb-text-xl mb-font-bold">📷 Escanear Código QR</h2>
            </div>
            <div class="mb-card-body mb-flex mb-flex-col mb-items-center mb-gap-lg">
                <p class="mb-text-base mb-text-muted mb-mb-md">Usa tu cámara para registrar entregas de forma rápida.</p>
                <button class="btn-escanear mb-btn mb-btn-primary mb-btn-lg" @onclick="EscanearQR" aria-label="Iniciar escaneo QR">
                    <i class="fa fa-qrcode mb-mr-sm" aria-hidden="true"></i> Iniciar Escaneo
                </button>
            </div>
        </div>
    </section>

    @if (modalFirmaVisible)
    {
        <div class="firma-modal-backdrop" role="dialog" aria-modal="true" aria-label="Modal de firma">
            <div class="firma-modal">
                <h3 class="mb-text-lg mb-font-bold mb-mb-sm">Firma del destinatario</h3>
                <canvas id="firmaCanvas"
                        width="300"
                        height="120"
                        @onpointerdown="StartDraw"
                        @onpointerup="EndDraw"
                        @onpointerleave="EndDraw"
                        @onpointermove="Draw"
                        style="touch-action:none; border:1.5px solid #2943d1; border-radius:7px; background:#fff; box-shadow:0 2px 12px #2943d122;"
                        aria-label="Área para firmar">
                </canvas>
                <div class="firma-modal-btns mb-flex mb-gap-md mb-mt-md">
                    <button class="btn-firma mb-btn mb-btn-secondary" @onclick="ClearCanvas">Limpiar</button>
                    <button class="btn-firma mb-btn mb-btn-success" @onclick="AceptarFirma">Aceptar</button>
                    <button class="btn-cerrar mb-btn mb-btn-error" @onclick="CerrarModalFirma">Cancelar</button>
                </div>
            </div>
        </div>
    }
</div>
