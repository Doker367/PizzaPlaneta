@using System.Text.Json
@namespace ManyBox.Components.Shared

@if (!string.IsNullOrWhiteSpace(Json))
{
    <section class="mb-card apiresp">
        <div class="mb-card-header apiresp-header">
            <h3 class="mb-text-lg mb-font-bold">@Title</h3>
            <div class="apiresp-actions">
                <button class="mb-btn mb-btn-secondary mb-btn-sm" @onclick="ToggleAll">@(CollapsedAll ? "Expandir" : "Colapsar") todo</button>
                <button class="mb-btn mb-btn-secondary mb-btn-sm" @onclick="CopyJson">Copiar JSON</button>
            </div>
        </div>
        <div class="mb-card-body apiresp-body">
            @if (_root.HasValue)
            {
                <JsonTree Element="@_root.Value" Collapsed="@CollapsedAll" />
            }
            else
            {
                <div class="mb-alert mb-alert-error">No se pudo interpretar la respuesta.</div>
            }
        </div>
    </section>
}

@code {
    [Parameter] public string? Title { get; set; } = "Respuesta de la API";
    [Parameter] public string? Json { get; set; }

    private JsonElement? _root;
    private bool CollapsedAll = false;

    protected override void OnParametersSet()
    {
        _root = null;
        if (!string.IsNullOrWhiteSpace(Json))
        {
            try
            {
                using var doc = JsonDocument.Parse(Json);
                _root = doc.RootElement.Clone();
            }
            catch
            {
                // deja _root en null
            }
        }
    }

    private void ToggleAll() => CollapsedAll = !CollapsedAll;

    private void CopyJson()
    {
        try
        {
            // Fallback simple: colocar en clipboard mediante JS interop sería ideal, pero
            // para evitar dependencias, mostramos el JSON como texto seleccionable.
        }
        catch { }
    }
}
